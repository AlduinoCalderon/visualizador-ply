import{s as B,a as x}from"./mqtt-setup-A007qq7Q.js";import{m as S,C as A,n as L,o as E,p as z,q as f,r as M,f as b,t as P,W as j,A as I,H as R,D as v,h as w,u as C}from"./three-s0w8xr1i.js";import{O as F,P as T}from"./loaders-Cem-VtSN.js";import{O as k}from"./controls-BycUIGfH.js";class H{constructor(s="viewer-container"){this.container=document.getElementById(s)||document.body,this.currentModel=null,this.isShelfModel=!0,this.initScene(),this.initLights(),this.initControls(),this.setupEventListeners(),this.loadShelfModel()}initScene(){this.scene=new S,this.scene.background=new A(16777215),this.scene.fog=new L(16777215,1,30);const s=40,t=new E(s,40,13421772,15132390);t.position.y=-1.4,this.scene.add(t);const i=new z(s,s/2),o=new f({color:14737632,side:M,roughness:.8,metalness:.1}),a=new b(i,o);a.position.z=-40/4,a.position.y=s/4-1.4,this.scene.add(a),this.camera=new P(60,this.container.clientWidth/this.container.clientHeight,.1,1e3),this.camera.position.set(5.1,4.85,9.99),this.renderer=new j({antialias:!0}),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.container.appendChild(this.renderer.domElement)}initLights(){const s=new I(4210752,.5);this.scene.add(s);const t=new R(16777215,4473924,.8);this.scene.add(t);const i=new v(16777215,1);i.position.set(1,1,2),this.scene.add(i);const o=new v(16777215,.3);o.position.set(0,1,-1),this.scene.add(o)}initControls(){this.controls=new k(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.rotateSpeed=.5,this.controls.minDistance=4,this.controls.maxDistance=20,this.controls.target.set(1.28,3.82,.12),this.controls.mouseButtons={LEFT:w.ROTATE,MIDDLE:w.DOLLY,RIGHT:w.PAN},this.controls.minPolarAngle=0,this.controls.maxPolarAngle=Math.PI,this.controls.minAzimuthAngle=-1/0,this.controls.maxAzimuthAngle=1/0,this.controls.enablePan=!0,this.controls.panSpeed=.5}setupEventListeners(){window.addEventListener("resize",()=>{this.camera.aspect=this.container.clientWidth/this.container.clientHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.container.clientWidth,this.container.clientHeight)})}async loadShelfModel(){new F().load("./models/Shelf.obj",t=>{t.traverse(o=>{o instanceof b&&(o.material=new f({color:8421504,flatShading:!1,roughness:.7,metalness:.3}))}),t.scale.set(.005,.005,.005);const i=new C().setFromObject(t);t.position.y=-i.min.y*t.scale.y+8.529,this.scene.add(t),this.currentModel=t,this.setupSensors()})}setupSensors(){let s=null,t=null,i=null;const o=25e3;let a=!1;const u=[{id:"shoe_rojo",color:16711680,yPosition:4.608},{id:"shoe_azul",color:255,yPosition:2.5}],c=e=>{const h=new T;return new Promise(l=>{h.load("./models/Shoe.ply",d=>{d.computeVertexNormals(),d.center();const g=new f({color:e.color}),p=new b(d,g);p.name=e.id,p.scale.set(.0237,.0237,.0237),p.position.set(0,e.yPosition,0),p.visible=!1,this.scene.add(p),l(p)})})},m=async()=>{for(const e of u){const h=await c(e);this[e.id]=h}},r=e=>{this.shoeRojo&&(this.shoeRojo.visible=e.proximity1<39),this.shoeAzul&&(this.shoeAzul.visible=e.proximity2<39),this.showShelfOccupancyBox(this.shoeRojo&&this.shoeRojo.visible,this.shoeAzul&&this.shoeAzul.visible,s,t)},n=()=>{i&&clearTimeout(i),a||(i=setTimeout(async()=>{var e,h;try{const l=await fetch("https://coldstoragehub.onrender.com/api/mongodb/readings/proximity?unitId=1",{mode:"cors",headers:{Accept:"application/json"}});if(!l.ok)throw new Error(`Error HTTP: ${l.status}`);const d=await l.json();r({proximity1:((e=d.proximity1)==null?void 0:e.value)||100,proximity2:((h=d.proximity2)==null?void 0:h.value)||100}),a=!0}catch(l){console.error("Error en fallback fetch:",l)}},o))};m().then(()=>{B(),x("warehouse/unit/1/sensor/proximity1",e=>{r({proximity1:e.value,proximity2:this.shoeAzul&&this.shoeAzul.visible?0:100}),n()}),x("warehouse/unit/1/sensor/proximity2",e=>{r({proximity1:this.shoeRojo&&this.shoeRojo.visible?0:100,proximity2:e.value}),n()}),x("warehouse/unit/1/sensor/temperature",e=>{s=e.value,r({proximity1:this.shoeRojo&&this.shoeRojo.visible?0:100,proximity2:this.shoeAzul&&this.shoeAzul.visible?0:100}),n()}),x("warehouse/unit/1/sensor/humidity",e=>{t=e.value,r({proximity1:this.shoeRojo&&this.shoeRojo.visible?0:100,proximity2:this.shoeAzul&&this.shoeAzul.visible?0:100}),n()}),n()})}showShelfOccupancyBox(s,t,i=null,o=null){if(!this.occupancyBox){this.occupancyBox=document.createElement("div"),this.occupancyBox.className="occupancy-box",this.occupancyBox.style.position="absolute",this.occupancyBox.style.top="20px",this.occupancyBox.style.right="20px",this.occupancyBox.style.background="rgba(255, 255, 255, 0.9)",this.occupancyBox.style.color="#333",this.occupancyBox.style.padding="12px 15px",this.occupancyBox.style.borderRadius="8px",this.occupancyBox.style.fontFamily="system-ui, -apple-system, sans-serif",this.occupancyBox.style.fontSize="14px",this.occupancyBox.style.zIndex="1000",this.occupancyBox.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",this.occupancyBox.style.maxWidth="300px",this.occupancyBox.style.wordBreak="break-word",this.occupancyBox.style.display="flex",this.occupancyBox.style.flexDirection="column",this.occupancyBox.style.alignItems="flex-start",this.occupancyBox.style.gap="8px",this.occupancyBox.style.backdropFilter="blur(4px)",this.renderer.domElement.parentElement.appendChild(this.occupancyBox);const e=document.createElement("style");e.textContent=`
        .occupancy-box .sensor-row {
          display: flex;
          flex-direction: row;
          gap: 12px;
          flex-wrap: wrap;
          margin-top: 4px;
          width: 100%;
        }
        .occupancy-box .sensor-item {
          min-width: 80px;
          font-size: 13px;
        }
        .occupancy-box b {
          color: #666;
          font-weight: 500;
        }
      `,document.head.appendChild(e)}const a=10,u=.025;let c=0;s&&c++,t&&c++;const m=c*u,r=(m/(a*u)*100).toFixed(1);let n="";c>0&&(n+=`<div><b>Estantes ocupados:</b> ${c}</div>`,n+=`<div><b>Metros usados:</b> ${m.toFixed(3)} m³</div>`,n+=`<div><b>Porcentaje de ocupación:</b> ${r}%</div>`),(i!==null||o!==null)&&(n+=`<div class='sensor-row'>
        <div class='sensor-item'><b>Temp:</b> ${i!==null?i:"--"} °C</div>
        <div class='sensor-item'><b>Humedad:</b> ${o!==null?o:"--"} %</div>
      </div>`),this.occupancyBox.innerHTML=n,this.occupancyBox.style.display=n?"block":"none"}animate(){this.animationFrameId=requestAnimationFrame(this.animate.bind(this)),this.controls.update(),this.renderer.render(this.scene,this.camera)}dispose(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.controls&&this.controls.dispose(),this.currentModel=null,this.scene=null,this.camera=null,this.renderer.dispose()}}document.addEventListener("DOMContentLoaded",()=>{const y=new H("viewer-container");y.animate(),window.embeddedViewer=y});
